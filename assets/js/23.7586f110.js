(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{597:function(s,t,a){s.exports=a.p+"assets/img/master_slave_process.ec1b44a4.png"},698:function(s,t,a){"use strict";a.r(t);var e=a(11),r=Object(e.a)({},(function(){var s=this,t=s.$createElement,e=s._self._c||t;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[s._v("在Mysql中，默认只开启了错误日志。如果想开启其他的日志，需要手动在 "),e("code",[s._v("/etc/my.cnf")]),s._v(" 配置文件中开启")]),s._v(" "),e("h2",{attrs:{id:"日志类型"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#日志类型"}},[s._v("#")]),s._v(" 日志类型")]),s._v(" "),e("ul",[e("li",[e("strong",[s._v("错误日志")]),s._v("：记录启动、运行或停止时出现的问题，一般也会记录警告信息")]),s._v(" "),e("li",[e("strong",[s._v("查询日志")]),s._v("：记录建立的客户端连接和执行的语句(不应该开启)")]),s._v(" "),e("li",[e("strong",[s._v("慢查询日志")]),s._v("：记录所有执行时间超过 long_query_time 秒的所有查询或不使用索引的查询，可以帮我们定位服务器性能问题。")]),s._v(" "),e("li",[e("strong",[s._v("二进制日志")]),s._v("：任何引起或可能引起数据库变化的操作，主要用于复制和即时点恢复。")]),s._v(" "),e("li",[e("strong",[s._v("中继日志")]),s._v("：从主服务器的二进制日志文件中复制而来的事件，并保存为的日志文件")]),s._v(" "),e("li",[e("strong",[s._v("事务日志")]),s._v("：记录InnoDB等支持事务的存储引擎执行事务时产生的日志")])]),s._v(" "),e("h2",{attrs:{id:"数据库的组从复制"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#数据库的组从复制"}},[s._v("#")]),s._v(" 数据库的组从复制")]),s._v(" "),e("p",[s._v("主从复制是MySQL中最重要的功能之一。主从复制是指一台服务器充当主数据库服务器，另一台或多台服务器充当从数据库服务器，主服务器中的数据自动复制到从服务器之中。对于多级复制，数据库服务器即可充当主机，也可充当从机。MySQL主从复制的基础是主服务器对数据库修改记录二进制日志，从服务器通过主服务器的二进制日志自动执行更新")]),s._v(" "),e("h3",{attrs:{id:"主从复制的类型"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#主从复制的类型"}},[s._v("#")]),s._v(" 主从复制的类型")]),s._v(" "),e("blockquote",[e("p",[s._v("基于语句的复制：")])]),s._v(" "),e("ul",[e("li",[s._v("描述: 主服务器上面执行的语句在从服务器上面再执行一遍")]),s._v(" "),e("li",[s._v("问题: 时间上可能不完全同步造成偏差，执行语句的用户也可能不是同一个用户")])]),s._v(" "),e("blockquote",[e("p",[s._v("基于行的复制")])]),s._v(" "),e("ul",[e("li",[s._v("描述: 把主服务器上面改编后的内容直接复制过去，而不关心到底改变该内容是由哪条语句引发的")]),s._v(" "),e("li",[s._v("问题: 比如一个工资表中有一万个用户，我们把每个用户的工资+1000，那么基于行的复制则要复制一万行的内容，由此造成的开销比较大，而基于语句的复制仅仅一条语句就可以了")])]),s._v(" "),e("blockquote",[e("p",[s._v("混合类型的复制")])]),s._v(" "),e("ul",[e("li",[s._v("描述: MySQL默认使用基于语句的复制，当基于语句的复制会引发问题的时候就会使用基于行的复制，MySQL会自动进行选择")])]),s._v(" "),e("h3",{attrs:{id:"主从复制原理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#主从复制原理"}},[s._v("#")]),s._v(" 主从复制原理")]),s._v(" "),e("ol",[e("li",[s._v("主服务器上面的任何修改都会保存在二进制日志"),e("code",[s._v("Binary log")]),s._v("里面")]),s._v(" "),e("li",[s._v("从服务器上面启动一个"),e("code",[s._v("I/O thread")]),s._v("，连接到主服务器上面请求读取二进制日志，然后把读取到的二进制日志写到本地的一个"),e("code",[s._v("Realy log")]),s._v("里面")]),s._v(" "),e("li",[s._v("从服务器上面开启一个"),e("code",[s._v("SQL thread")]),s._v("定时检查"),e("code",[s._v("Realy log")]),s._v("，如果发现有更改立即把更改的内容在本机上面执行一遍")])]),s._v(" "),e("p",[e("img",{attrs:{src:a(597),alt:"master_slave_process"}})]),s._v(" "),e("h3",{attrs:{id:"主从复制的步骤"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#主从复制的步骤"}},[s._v("#")]),s._v(" 主从复制的步骤")]),s._v(" "),e("ul",[e("li",[s._v("主服务器：ip：192.168.10.139   系统：Centos7        数据库：MySQL")]),s._v(" "),e("li",[s._v("从服务器：ip：192.168.10.129   系统：Centos7        数据库：MySQL")]),s._v(" "),e("li",[e("strong",[s._v("注意: 在进行主从配置之前，两个服务器上的数据库的信息要完全一致！！！")]),s._v(":")])]),s._v(" "),e("blockquote",[e("p",[s._v("主服务器配置")])]),s._v(" "),e("ol",[e("li",[s._v("修改主服务器配置文件 "),e("code",[s._v("/etc/my.cnf")]),s._v("，修改完后需要重启 mysql 服务：systemctl restart mysql")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("mysqld"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nlog-bin"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mysql-bin         // 启用二进制日志"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("必选"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nserver-id"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("139")]),s._v("             // 设置服务器唯一ID，一般取IP最后一段"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("必选"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nbinlog-do-db"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("140")]),s._v("          // 指定对db_nameA记录二进制日志"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("可选"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\nbinlog-ignore-db"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v("mysql    // 指定不对db_namB记录二进制日志"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("可选"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("ol",{attrs:{start:"2"}},[e("li",[s._v("为从服务器添加 mysql 账户并配置权限，在主服务器上，必须为从服务器创建一个用来连接主服务器的用户，并设置 replication slave 权限")])]),s._v(" "),e("p",[e("code",[s._v("mysql>grant replication slave on *.* to backup@'192.168.10.129' identified by '123';")])]),s._v(" "),e("ol",{attrs:{start:"3"}},[e("li",[s._v("刷新权限")])]),s._v(" "),e("p",[e("code",[s._v("mysql>flush privileges;")])]),s._v(" "),e("ol",{attrs:{start:"4"}},[e("li",[s._v("验证是否开启主从复制")])]),s._v(" "),e("p",[e("code",[s._v("mysql>select * from user where user = 'backup' \\G;")])]),s._v(" "),e("ol",{attrs:{start:"5"}},[e("li",[s._v("查看主服务器正在使用二进制日志状态")])]),s._v(" "),e("p",[e("code",[s._v("mysql>show master status;")])]),s._v(" "),e("blockquote",[e("p",[s._v("从服务器配置")])]),s._v(" "),e("ol",[e("li",[s._v("修改从服务器配置文件 "),e("code",[s._v("/etc/my.cnf")]),s._v("，修改完后需要重启 mysql 服务: systemctl restart mysql")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),s._v("mysqld"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),s._v("\nserver-id"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("129")]),s._v("              //必须服务器唯一ID，一般取IP最后一段"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("必选"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("ol",{attrs:{start:"2"}},[e("li",[s._v("进入数据库，设置主服务器信息")])]),s._v(" "),e("div",{staticClass:"language-bash line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-bash"}},[e("code",[s._v("mysql"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" change master to "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("master_host")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'192.168.10.139'")]),s._v(",\n    -"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("master_user")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'backup'")]),s._v(",\n    -"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("master_password")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'123'")]),s._v(",\n    -"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("master_log_file")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mysql-bin.000001'")]),s._v(",  // master status "),e("span",{pre:!0,attrs:{class:"token function"}},[s._v("file")]),s._v("\n    -"),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v(">")]),s._v(" "),e("span",{pre:!0,attrs:{class:"token assign-left variable"}},[s._v("master_log_pos")]),e("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),e("span",{pre:!0,attrs:{class:"token number"}},[s._v("245")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("                  // master status position\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br")])]),e("ol",{attrs:{start:"3"}},[e("li",[s._v("开启从服务器复制二进制日志，实现同步功能")])]),s._v(" "),e("p",[e("code",[s._v("slave start;")])]),s._v(" "),e("ol",{attrs:{start:"4"}},[e("li",[s._v("验证数据库相关参数")])]),s._v(" "),e("p",[e("code",[s._v("show slave status \\G;")])]),s._v(" "),e("h2",{attrs:{id:"数据库的备份和还原"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#数据库的备份和还原"}},[s._v("#")]),s._v(" 数据库的备份和还原")]),s._v(" "),e("blockquote",[e("p",[s._v("衡量备份还原的指标：")])]),s._v(" "),e("ul",[e("li",[s._v("RPO：恢复点目标，恢复的程度")]),s._v(" "),e("li",[s._v("RIO：恢复时间目标，恢复花费的时间")])]),s._v(" "),e("blockquote",[e("p",[s._v("备份方式：")])]),s._v(" "),e("ul",[e("li",[s._v("冷备份：拷贝数据库目录，需要先停机再备份，对于在线不间断提供业务的不适用")]),s._v(" "),e("li",[s._v("快照备份：lvm快照，mysql 装在 lvm 创建的分区，可以热备份(在线备份)，缺点在于所有的文件，包括数据、日志等需要存放在一个逻辑卷中，然后再对卷快照备份，只支持本地备份，生产环境用的也比较少")]),s._v(" "),e("li",[s._v("逻辑备份： mysqldump 工具，单线程备份，备份速度较慢；mydumper 工具，mysqldump 升级版，有限制条件")])]),s._v(" "),e("blockquote",[e("p",[s._v("备份单个库：")])]),s._v(" "),e("ul",[e("li",[s._v("备份：mysqldump -uroot -p dbname1 > 1.sql")]),s._v(" "),e("li",[s._v("还原：mysql -uroot -p dbname2 < 1.sql")]),s._v(" "),e("li",[s._v("注意：这里还原的时候这个 dbname2 是数据库名，必须要有，dbname1 和 dbname2 可以不一致")])]),s._v(" "),e("blockquote",[e("p",[s._v("备份多个库：")])]),s._v(" "),e("ul",[e("li",[s._v("备份：mysqldump -uroot -p --database db1 db2 > 1.sql")]),s._v(" "),e("li",[s._v("还原： mysql  -uroot -p < 1.sql")])]),s._v(" "),e("blockquote",[e("p",[s._v("备份全部库：")])]),s._v(" "),e("ul",[e("li",[s._v("备份：mysqldump -uroot -p --all-databases > 1.sql")]),s._v(" "),e("li",[s._v("还原：mysql -uroot -p < 1.sql")])]),s._v(" "),e("blockquote",[e("p",[s._v("备份单个表：")])]),s._v(" "),e("ul",[e("li",[s._v("备份：mysqldump dbname1 tb1 > 1.sql")]),s._v(" "),e("li",[s._v("还原：mysql -uroot -p dbname2 < 1.sql")]),s._v(" "),e("li",[s._v("注意：这里还原的时候这个 dbname2 是数据库名，必须要有，dbname1 和 dbname2 可以不一致")])]),s._v(" "),e("h2",{attrs:{id:"参考"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[s._v("#")]),s._v(" 参考")]),s._v(" "),e("p",[e("a",{attrs:{href:"https://blog.csdn.net/qq_36119192/article/details/82862621",target:"_blank",rel:"noopener noreferrer"}},[s._v("数据库日志、主从复制、备份和还原"),e("OutboundLink")],1)])])}),[],!1,null,null,null);t.default=r.exports}}]);