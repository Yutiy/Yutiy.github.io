---
title: '实现new操作符'
date: 2020-03-26
permalink: 'js_deep/new'
tag:
  - javascript基础系列
categories:
  - javascript基础系列
---

`new` 使用的时候需要做三件事情:

- 让实例可以访问到私有属性
- 让实例可以访问到构造函数原型所在原型链上的属性
- 判断构造函数返回结果的类型

```js
const myNew = function(ctor, ...args) {
  if (typeof ctor !== 'function') {
    throw 'ctor must be a function';
  }

  const object = new Object();
  object.__proto__ = Object.create(ctor.prototype);

  const result = ctor.apply(object, args)
  const isObject = typeof result === 'object' && result !== null;
  const isFunction = typeof result === 'function';

  return isObject || isFunction ? result : object
}
```

为啥会这样呢，可以看下 new 的实现原理:

1. 创建一个新对象
2. 这个对象会被执行 `[[原型]]` 连接
3. 属性和方法被加入到 this 引用的对象中，并执行构造函数中的方法
4. 如果函数没有返回其他对象，那么 this 指向这个新对象，否则 this 指向构造函数中返回的对象
