---
title: 'definePropertyä¸Proxy'
date: 2020-03-26
permalink: 'es6/proxy'
tag:
  - ES6
categories:
  - ES6
---

## defineProperty

è¯¥æ–¹æ³•å¯ä»¥åœ¨ä¸€ä¸ªå¯¹è±¡ä¸Šé¢å®šä¹‰ä¸€ä¸ªæ–°å±æ€§ï¼Œæˆ–è€…ä¿®æ”¹ä¸€ä¸ªå¯¹è±¡çš„ç°æœ‰å±æ€§ï¼Œå¹¶è¿”å›è¿™ä¸ªå¯¹è±¡ã€‚

**è¯­æ³•**

> Object.defineProperty(obj, prop, descriptor);

**å‚æ•°**

- obj: è¦åœ¨å…¶ä¸Šé¢å®šä¹‰å±æ€§çš„å¯¹è±¡
- prop: è¦å®šä¹‰æˆ–ä¿®æ”¹çš„å±æ€§åç§°
- description: å°†è¢«å®šä¹‰æˆ–ä¿®æ”¹çš„å±æ€§çš„æè¿°ç¬¦

ä¸¾ä¸ªğŸŒ° :

```js
var obj = {};

// å¯¹è±¡ obj æ‹¥æœ‰å±æ€§ numï¼Œå…¶å€¼ä¸º 1
Object.defineProperty(obj, 'num', {
  value: 1,
  writable: true,
  enumerable: true,
  configurable: true
})
```

å‡½æ•°çš„ç¬¬ä¸‰ä¸ªå‚æ•° descriptor æ‰€è¡¨ç¤ºçš„å±æ€§æè¿°ç¬¦æœ‰ä¸¤ç§å½¢å¼: **æ•°æ®æè¿°ç¬¦å’Œå­˜å–æè¿°ç¬¦**ã€‚

*ä¸¤è€…å‡å…·æœ‰ä»¥ä¸‹ä¸¤ç§é”®å€¼*:

**configurable**

```
å½“ä¸”ä»…å½“è¯¥å±æ€§ configurable ä¸º true æ—¶ï¼Œè¯¥å±æ€§æè¿°ç¬¦æ‰èƒ½å¤Ÿè¢«æ”¹å˜ï¼Œä¹Ÿèƒ½å¤Ÿè¢«åˆ é™¤ã€‚é»˜è®¤ä¸º falseã€‚
```

**enumerable**

```
å½“ä¸”ä»…å½“è¯¥å±æ€§ enumerable ä¸º true æ—¶ï¼Œè¯¥å±æ€§æ‰èƒ½å‡ºç°åœ¨å¯¹è±¡çš„æšä¸¾å±æ€§ä¸­ã€‚é»˜è®¤ä¸º falseã€‚
```

*æ•°æ®æè¿°ç¬¦åŒæ—¶å…·æœ‰ä¸€ä¸‹å¯é€‰é”®å€¼*:

**value**

```
è¯¥å±æ€§å¯¹åº”çš„å€¼ã€‚å¯ä»¥æ˜¯ä»»ä½•æœ‰æ•ˆçš„ Javascript å€¼ï¼ˆæ•°å€¼ã€å¯¹è±¡ã€å‡½æ•°ç­‰ï¼‰ã€‚é»˜è®¤ä¸º undefinedã€‚
```

**writable**

```
å½“ä¸”ä»…å½“è¯¥å±æ€§ writable ä¸º true æ—¶ï¼Œè¯¥å±æ€§æ‰èƒ½è¢«èµ‹å€¼è¿ç®—ç¬¦æ”¹å˜ã€‚é»˜è®¤ä¸º falseã€‚
```

*å­˜å–æè¿°ç¬¦åŒæ—¶å…·æœ‰ä¸€ä¸‹å¯é€‰é”®å€¼*:

**get**

```
ä¸€ä¸ªç»™å±æ€§æä¾› getter çš„æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰ getter åˆ™ä¸º undefinedã€‚è¯¥æ–¹æ³•è¿”å›å€¼è¢«ç”¨ä½œå±æ€§å€¼ã€‚é»˜è®¤ä¸º undefinedã€‚
```

**set**

```
ä¸€ä¸ªç»™å±æ€§æä¾› setter çš„æ–¹æ³•ï¼Œå¦‚æœæ²¡æœ‰ setter åˆ™ä¸º undefinedã€‚è¯¥æ–¹æ³•å°†æ¥å—å”¯ä¸€å‚æ•°ï¼Œå¹¶å°†è¯¥å‚æ•°çš„æ–°å€¼åˆ†é…ç»™è¯¥å±æ€§ã€‚é»˜è®¤ä¸º undefinedã€‚
```

å€¼å¾—æ³¨æ„çš„æ˜¯: **å±æ€§æè¿°ç¬¦å¿…é¡»æ˜¯æ•°æ®æè¿°ç¬¦æˆ–è€…å­˜å–æè¿°ç¬¦ä¸¤ç§å½¢å¼ä¹‹ä¸€ï¼Œä¸èƒ½åŒæ—¶æ˜¯ä¸¤è€…ã€‚å¦å¤–æ‰€æœ‰çš„å±æ€§æè¿°ç¬¦éƒ½æ˜¯éå¿…é¡»çš„ï¼Œä½†æ˜¯ descriptor è¿™ä¸ªå­—æ®µæ˜¯å¿…é¡»çš„ã€‚**ã€‚

## watch API

æ—¢ç„¶å¯ä»¥ç›‘æ§æ•°æ®æ”¹å˜ï¼Œé‚£è®¾æƒ³å½“æ•°æ®æ”¹å˜çš„æ—¶å€™ï¼Œé¡µé¢å°±å¯ä»¥è‡ªåŠ¨æ¸²æŸ“å·¥ä½œã€‚ä¸¾ä¸ªğŸŒ° ï¼š

HTMLä¸­æœ‰ä¸ª span æ ‡ç­¾å’Œ button æ ‡ç­¾ï¼Œå½“ç‚¹å‡»æŒ‰é’®æ—¶ï¼Œspan æ ‡ç­¾é‡Œçš„å€¼åŠ  1ã€‚

```html
<span id="container">1</span>
<button id="button">ç‚¹å‡»åŠ  1</button>
```

ä¼ ç»Ÿçš„åšæ³•æ˜¯:

```js
var container = document.getElementById('container');
document.getElementById('button').addEventListener('click', function() {
  container.innerHTML = Number(container.innerHTML) + 1;
}, false);
```

å¦‚æœä½¿ç”¨äº† definePropertyï¼š

```js
var obj = {
  value: 1
}

// å‚¨å­˜ obj.value çš„å€¼
var value = 1;
var container = document.getElementById('container');

Object.defineProperty(obj, "value", {
  get: function() {
    return value;
  },
  set: function(newVal) {
    value = newVal;
    container.innerHTML = newVal;
  }
});

document.getElementById('button').addEventListener("click", function() {
  obj.value += 1;
});
```

ä»£ç å¢å¤šäº†ï¼Œä½†æ˜¯æ›´æ”¹çš„æ—¶å€™åªè¦ç›´æ¥ä¿®æ”¹ obj.value å€¼å°±å¯ä»¥äº†ã€‚

ä½†æ˜¯ç°åœ¨çš„å†™æ³•ï¼Œè¿˜éœ€è¦å•ç‹¬å£°æ˜ä¸€ä¸ªå˜é‡å­˜å‚¨ obj.value å€¼ï¼Œå› ä¸ºå¦‚æœåœ¨ set ä¸­ç›´æ¥ `obj.value = newVal` å°±ä¼šé™·å…¥æ— é™å¾ªç¯ä¸­ã€‚æ­¤å¤–å¯èƒ½éœ€è¦ç›‘æ§å¤šä¸ªå±æ€§å€¼æ”¹å˜ï¼Œä¸ºé¿å…ç¹çï¼Œæ‰€ä»¥ç®€å†™ä¸€ä¸ª watch å‡½æ•°ï¼Œå¦‚ä¸‹ï¼š

```js
(function() {
  var root = this;
  function watch(obj, name, func) {
    var value = obj[name];

    defineProperty(obj, name, {
      get: function() {
        return value;
      },
      set: function(newVal) {
        value = newVal;
        func(value);
      }
    })

    if (value) obj[name] = value;
  }

  this.watch = watch;
})();
```

ç„¶åä½¿ç”¨å¦‚ä¸‹:

```js
var obj = { value: 1 };
var container = document.getElementById('container');

watch(obj, 'value', function(newVal) {
  container.innerHTML = newVal;
})

document.getElementById('button').addEventListener('click', function() {
  obj.value += 1;
}, false);
```

## Proxy

ä½¿ç”¨ defineProperty åªèƒ½é‡å®šä¹‰å±æ€§çš„è¯»å–ï¼ˆgetï¼‰å’Œè®¾ç½®ï¼ˆsetï¼‰è¡Œä¸ºï¼Œåˆ°äº† ES6ï¼Œæä¾›äº† Proxyï¼Œå¯ä»¥é‡å®šä¹‰æ›´å¤šçš„è¡Œä¸ºï¼Œæ¯”å¦‚ inã€deleteã€å‡½æ•°è°ƒç”¨ç­‰æ›´å¤šè¡Œä¸ºã€‚

**è¯­æ³•**

> var proxy = new Proxy(target, handler);

**è¯´æ˜**
- new Proxy(): ç”Ÿæˆä¸€ä¸ª Proxy å®ä¾‹
- targetï¼šå‚æ•°è¡¨ç¤ºæ‰€è¦æ‹¦æˆªçš„ç›®æ ‡å¯¹è±¡
- handlerï¼šä¸€ä¸ªå¯¹è±¡ï¼Œå…¶å±æ€§æ˜¯å½“æ‰§è¡Œä¸€ä¸ªæ“ä½œæ—¶å®šä¹‰ä»£ç†çš„è¡Œä¸ºçš„å‡½æ•°ã€‚

ä¸¾ä¸ªğŸŒ° :

```js
var target = { _prop: 'foo', prop: 'foo' };
var proxy = new Proxy(target, {
  get: function(obj, prop) {
    console.log('è®¾ç½® get æ“ä½œ')
    return obj[prop];
  },
  set: function(obj, prop, value) {
    console.log('è®¾ç½® set æ“ä½œ')
    obj[prop] = value;
  },

  // ä½¿ç”¨ has æ–¹æ³•éšè—æŸäº›å±æ€§ï¼Œä¸è¢« in è¿ç®—ç¬¦å‘ç°
  has (target, key) {
    if (key[0] === '_') {
      return false;
    }
    return key in target;
  }
});

proxy.time = 35; // è®¾ç½® set æ“ä½œ
console.log(proxy.time); // è®¾ç½® get æ“ä½œ // 35
console.log('_prop' in proxy); // false
```

proxy å¯ä»¥æ‹¦æˆªå¤šè¾¾ 13 ç§æ“ä½œï¼Œæ¯”å¦‚è¯´ ownKeys æ–¹æ³•å¯ä»¥æ‹¦æˆªå¯¹è±¡è‡ªèº«å±æ€§çš„è¯»å–æ“ä½œã€‚å…·ä½“æ¥è¯´ï¼Œæ‹¦æˆªä»¥ä¸‹æ“ä½œï¼š

- Object.getOwnPropertyNames()
- Object.getOwnPropertySymbols()
- Object.keys()

ä¸‹é¢çš„ä¾‹å­æ˜¯æ‹¦æˆªç¬¬ä¸€ä¸ªå­—ç¬¦ä¸ºä¸‹åˆ’çº¿çš„å±æ€§åï¼Œä¸è®©å®ƒè¢« for of éå†åˆ°ã€‚

```js
let target = {
  _bar: 'foo',
  _prop: 'bar',
  prop: 'baz'
};

let handler = {
  ownKeys(target) {
    return Reflect.ownKeys(target).filter(key => key[0] !== '_');
  }
};

let proxy = new Proxy(target, handler);
for (let key of Object.keys(proxy)) {
  console.log(target[key]);
}
// "baz"
```

æ›´å¤šçš„æ‹¦æˆªè¡Œä¸ºå¯ä»¥æŸ¥çœ‹é˜®ä¸€å³°è€å¸ˆçš„ [ã€ŠECMAScript 6 å…¥é—¨ã€‹](http://es6.ruanyifeng.com/#docs/proxy)

å€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œproxy çš„æœ€å¤§é—®é¢˜åœ¨äºæµè§ˆå™¨æ”¯æŒåº¦ä¸å¤Ÿï¼Œè€Œä¸”å¾ˆå¤šæ•ˆæœæ— æ³•ä½¿ç”¨ poilyfill æ¥å¼¥è¡¥ã€‚

## watch APIä¼˜åŒ–

æˆ‘ä»¬ä½¿ç”¨ proxy å†æ¥å†™ä¸€ä¸‹ watch å‡½æ•°ã€‚ä½¿ç”¨æ•ˆæœå¦‚ä¸‹ï¼š

```js
(function() {
  var root = this;
  function watch(target, func) {
    var proxy = new Proxy(target, {
      get: function(target, prop) {
        return target[prop];
      },
      set: function(target, prop, value) {
        target[prop] = value;
        func(prop, value);
      }
    });
    return proxy;
  }

  this.watch = watch;
})()

var obj = {
  value: 1
}

var container = document.getElementById('container');
var newObj = watch(obj, function(key, newVal) {
  if(key == 'value') container.innerHTML = newVal;
})

document.getElementById('button').addEventListener("click", function() {
  newObj.value += 1;
}, false);
```

## æ€»ç»“

- ä½¿ç”¨ definePropertyï¼Œæˆ‘ä»¬ä¿®æ”¹åŸæ¥çš„ obj å¯¹è±¡å°±å¯ä»¥è§¦å‘æ‹¦æˆª
- ä½¿ç”¨ proxyï¼Œå°±å¿…é¡»ä¿®æ”¹ä»£ç†å¯¹è±¡ï¼Œå³ Proxy çš„å®ä¾‹æ‰å¯ä»¥è§¦å‘æ‹¦æˆª
