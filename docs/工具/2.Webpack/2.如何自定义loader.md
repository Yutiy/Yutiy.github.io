---
title: '如何自定义loader'
date: 2020-03-26
permalink: 'webpack/loader'
tag:
  - webpack
categories:
  - webpack
---

loader 其实就是一个 node 模块，其导出一个函数，会在转换 `源模块(resource)` 的时候调用该函数。在这个函数内部，可以通过传入 `this` 上下文对象来给 loader 使用。

## 自定义less-loader

```js
const less = require('less');

function loader(source) {
  let css;
  less.render(source, function(err, output) {
    css = output.css;
  })
  return css;
}

module.exports = loader;
```

## 自定义css-loader

```js
function loader(source) {
  let reg = /url\((.+?)\)/g;
  let pos = 0
  let content;
  let arr = ['let list = []'];

  while(current = reg.exec(source)) {
    let [matchUrl, g] = current;
    console.log(matchUrl, g);
    let last = reg.lastIndex - matchUrl.length;
    arr.push(`list.push(${JSON.stringify(source.slice(pos, last))})`);

    pos = reg.lastIndex;

    // 把 g 替换成 require 写法 => url(require('xxx'))
    arr.push(`list.push('url('+require(${g})+')')`);
  }

  arr.push(`list.push(${JSON.stringify(source.slice(pos))})`);
  arr.push(`module.exports = list.join('')`);
  return arr.join('\r\n');
}

module.exports = loader;
```

## 自定义style-loader

```js
const loaderUtils = require('loader-utils');

function loader(source) {
  let str = `
    let style = document.createElement('style');
    style.innerHTML = ${JSON.stringify(source)};
    document.head.appendChild(style);
  `;

  return str;
}

// style-loader 去处理 less-loader!css-loader!./index.less
loader.pitch = function(remainingRequest) {
  // stringifyRequest 绝对路径转相对路径
  let str = `
    let style = document.createElement('style');
    style.innerHTML = require(${loaderUtils.stringifyRequest(this, '!!' + remainingRequest)});
    document.head.appendChild(style);
  `;

  return str;
}

module.exports = loader;
```
