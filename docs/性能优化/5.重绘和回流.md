---
title: '重绘和回流'
date: 2020-03-25
permalink: 'performance/reflow_repaint'
tag:
  - performance
categories:
  - performance
---

## 浏览器渲染

一个普通的网页，浏览器在渲染前要先构建 `DOM`(document object model) 和 `CSSOM`(css object model) 树;

### DOM

浏览器引擎会将收到的 HTML 标签转换成 DOM 树，构建过程如下:

> HTML字节 -> 字符 -> 令牌和节点化 -> 词法分析 -> DOM树构建

### CSSOM

浏览器引擎会将收到的 CSS 规则转换成浏览器能理解和处理的东西, 转换过程如下:

> css字节 -> 字符 -> 令牌和节点 -> CSSOM树构建

最后 `CSSOM` 树和 `DOM` 树合并成渲染树，并用它计算每个可见元素的布局，最终将像素渲染到屏幕上。

## 重绘和回流

回流往往代价比重绘大, 并且回流必定会导致重绘，重绘不一定回流。

> 回流: 对 DOM 操作导致 DOM 尺寸等属性的变化（比如修改元素的 `width、height、top`）时，浏览器需要重新计算元素的属性，然后再将计算的结果绘制出来。

常见的回流操作:

- 页面首次加载
- 浏览器窗口尺寸改变
- 元素尺寸或位置改变
- 元素内容变化
- 元素字体大小变化
- 增删 DOM 元素
- 查询或调用某些特定属性方法

> 重绘: 对 DOM 操作简单修改样式(比如修改元素的 `background-color, color, visibility`)却并未影响页面布局，浏览器不需要重新计算元素的位置尺寸等，直接为该元素绘制新的样式。

## 回流和重绘的优化

- 避免使用 `CSS` 表达式
- 使用 `transform` 代替 `top`
- JS避免频繁读取会引发回流/重绘的属性: 可以用缓存变量处理
- CSS硬件加速(GPU加速)
- 将动画效果应用到 `position` 属性为 `absolute` 或 `fixed` 的元素上，避免影响其他元素的布局，这样只是一个重绘，而不是回流
- 离线操作DOM，`createDocumentFragment, display: none`等
- 尽可能在DOM树的最末端改变 class：减小回流的范围
