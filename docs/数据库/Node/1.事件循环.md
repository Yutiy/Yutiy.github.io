---
title: '事件循环'
date: 2020-03-26
permalink: 'node/event_loop'
tag:
  - node
categories:
  - node
---

## 浏览器事件循环

1. 一开始整段脚本作为第一个宏任务执行
2. 执行过程中同步代码直接执行，宏任务进入宏任务队列，微任务进入微任务队列
3. 当前宏任务执行完出队，检查微任务队列，如果有则依次执行，直到微任务队列为空
4. 执行浏览器 UI 线程的渲染工作
5. 检查是否有Web worker任务，有则执行
6. 执行队首新的宏任务，回到2，依此循环，直到宏任务和微任务队列都为空

## nodejs事件循环

```bash
     |----------------|
|——> | timers         |  <--- 执行 `setTimeout`、`setInterval` 的回调
|    |----------------|
|           |
|           |   <--- 执行所有 `Next Tick Queue` 以及 `MircoTask Queue` 的回调
|           |
|    |------------------|
|--> | pending callback |  <-- 执行由上一个 Tick 延迟下来的 I/O 回调(待完善、可忽略)
|    |------------------|
|           |
|           |   <--- 执行所有 `Next Tick Queue` 以及 `MircoTask Queue` 的回调
|           |
|    |------------------|
|--> |   idle, prepare  |  <-- 内部调用(可忽略)
|    |------------------|
|           |
|           |   <--- 执行所有 `Next Tick Queue` 以及 `MircoTask Queue` 的回调
|           |
|    |------------------|
|--> |      poll        |  <-- `incoming、connections、data etc`, 执行所有回调，除了close callbacks
|    |------------------|
|           |
|           |   <--- 执行所有 `Next Tick Queue` 以及 `MircoTask Queue` 的回调
|           |
|    |------------------|
|--> |      check       |  <-- `setImmedidate` 会在这个阶段执行
|    |------------------|
|           |
|           |   <--- 执行所有 `Next Tick Queue` 以及 `MircoTask Queue` 的回调
|           |
|    |------------------|
|--> | close callbacks  |  <-- socket.on('close', ...)
     |------------------|
```

## 差异分析

两者最主要的区别在于浏览器中的微任务是在`每个相应的宏任务中执行的`，而nodejs中的微任务是`在不同阶段之间执行的`。
