---
title: 'Nginx基础'
date: 2020-03-26
permalink: 'nginx'
tag:
  - nginx
categories:
  - nginx
---

## Nginx介绍

Nginx是开源、高性能、高可靠的 Web 和反向代理服务器，其配置简单，并且支持热部署。性能是 Nginx 最重要的考量，其占用内存少、兵法能力强、能支持高达 5w 个并发连接，重要的是其免费支持商业化。

Nginx的最重要的几个使用场景:

- 静态资源服务，通过本地文件系统提供服务
- 反向代理服务，延伸出包括缓存、负载均衡等功能
- API服务，OpenResty

## 相关概念

### 简单请求和非简单请求

如果同时满足下面两个条件，就属于简单请求:

- 请求方法是 `HEAD、GET、POST` 三种之一
- HTTP头信息不超过以下头字段: `Accept、Accept-Lanage、Content-Language、Last-Event-ID、Content-Type`, 其中 Content-Type 只限于三个值 `application/x-www-form-urlencoded、multipart/form-data、text/plain`

凡是不同时满足这两个条件的，都属于非简单请求，浏览器处理简单请求和非简单请求的方式不一样:

**简单请求**

对于简单请求，浏览器会在头信息中增加 `Origin` 字段后直接发出，该字段用来说用，本次请求来自的那个源(协议+域名+端口)。

如果浏览器 `Origin` 指定的源不在许可范围内，服务器会返回一个正常的 HTTP 响应，浏览器取到响应之后发现其中的头信息中没有包含 `Access-Control-Allow-Origin` 字段，就抛出一个错误给 XHR 的 `error` 事件。

如果服务器发现 `Origin` 指定的域名在许可范围内，服务器返回的响应会多处几个 `Access-Control-` 开头的头信息字段。

**非简单请求**

浏览器针对非简单请求，在正式通信之前，会发送一次 HTTP 预检 `OPTIONS` 请求，先询问服务器，当前网页所在的域名是否在服务器的许可名单之中，以及可以使用那些 HTTP 请求方法和头信息字段。只有肯定响应浏览器才会发出正式的 XHR 请求，否则会报错。

### 跨域

在浏览器上当前访问的网站向另一个网站发送请求获取数据的过程就属于`跨域请求`。

跨域是浏览器的 [同源策略](https://developer.mozilla.org/zh-CN/docs/Web/Security/Same-origin_policy) 决定的，是一个重要的浏览器安全策略，用于限制一个 [origin](https://developer.mozilla.org/zh-CN/docs/Glossary/%E6%BA%90) 的文档或者它加载的脚本与另一个源的资源进行交互，它能够帮助阻隔恶意文档，减少可能被攻击的媒介，可以使用 [CORS](https://developer.mozilla.org/zh-CN/docs/Glossary/CORS) 配置解除这个限制。

如果当前源与另一个源的 `协议、host、端口` 三者有一个不同就属于不同源。

### 正向代理和反向代理

**正向代理**: 客户端向代理服务器发送请求，并指定目标服务器，然后由代理服务器和目标服务器通信，转交请求并获得内容后返回给客户端(比如使用梯子)。

**反向代理**: 直接收到请求的服务器是代理服务器，然后将请求转发给内部网络上真正进行处理的服务器，得到的结果返回给客户端(proxy_pass配置)。

### 负载均衡

一般情况下，客户端发送多个请求到服务器，服务器处理请求，其中一部分可能要操作一些资源如静态资源、数据库等，服务器处理完毕后，再将结果返回给客户端。

现如今，在请求爆发式增长的情况下，单机已经很难满足需求了，这时就需要进行集群，将请求(负载)分发到各个服务器上，这就是负载均衡。Nginx实现负载均衡，一般来说指的是将请求转发给服务器集群。

### 动静分离

为了加快网站的解析速度，可以把动态页面和静态页面由不同的服务器来解析，加快解析速度，降低原来单个服务器的压力。

如果请求的是静态资源，直接到静态资源目录获取资源，如果是动态资源的请求，则利用反向代理的原理，把请求转发到对应后台应用去处理，从而实现动静分离。

使用前后端分离后，可以很大程度上提升静态资源的访问资源，即使动态服务不可用，静态资源的访问也不会收到影响。

## Nginx安装及启动

```bash
# 查看 yum 中 nginx 版本
yum list | grep nginx

# 安装
yum install nginx

# 查看 nginx 版本号
nginx -v

# 查看 nginx 安装的相关文件
rpm -ql nginx
```

主要关注的文件夹有两个:

- `/etc/nginx/config.d`: 存放子配置的配置项，`/etc/nginx/nginx.conf` 主配置文件默认把这个文件夹下的所有子配置项都引入
- `/usr/share/nginx/html`: 通常静态文件都放在这个目录，也可以进行自定义

安装之后开启 Nginx，如果系统开启了防火墙，那么需要设置一下在防火墙中加入需要开发的端口，如下:

```bash
systemctl start firewalld
systemctl stop firewalld
systemctl status firewalld    # 查看防火墙开始状态，running表示正在运行
firewall-cmd --reload         # 重启防火墙，永久打开端口需要reload一下
firewall-cmd --list-all       # 查看防火墙，添加的端口也可看到

# 添加开启端口, --permanent表示永久打开，不加是临时打开重启后失效
firewall-cmd--permanent --zone=public --add-port=8888/tcp

systemctl enable nginx  # 设置 nginx 开机启动
systemctl disable nginx # 关闭 nginx 开机启动

systemctl start nginx # 启动nginx
systemctl restart nginx # 重启nginx
systemctl reload nginx # 重新加载nginx，用于修改配置后
systemctl stop nginx # 停止nginx
systemctl status nginx # 查看 Nginx 运行状态
```

同时也可以安装前端前端相关的工具nvm -> node, git:

```bash
# 下载 nvm，或者看官网的步骤 https://github.com/nvm-sh/nvm#install--update-script
curl -o- https://raw.githubusercontent.com/nvm-sh/nvm/v0.35.3/install.sh | bash

source ~/.bashrc      # 安装完毕后，更新配置文件即可使用 nvm 命令
nvm ls-remote         # 查看远程 node 版本
nvm install v12.16.3  # 选一个你要安装的版本安装，我这里选择 12.16.3
nvm list              # 安装完毕查看安装的 node 版本
node -v               # 查看是否安装好了

# git 安装
yum install git
```
