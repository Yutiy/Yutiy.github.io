---
title: 'Nginx常见配置'
date: 2020-03-26
permalink: 'nginx/common'
tag:
  - nginx
categories:
  - nginx
---

## 子域名使用

首先购买域名后，需要配置主机的二级域名如 `blog.ytxcloud.com`，等待解析生效后，在 `/etc/nginx/conf.d` 目录下新建 `blog.conf`, 配置如下:

```bash
server {
  listen 80;
  server_name blog.ytxcloud.com;

  location / {
    root /usr/share/nginx/html/blog;
    index index.html;
  }
}
```

## 反向代理

反向代理是最常用的服务功能，常用来解决跨域问题，加入要定向到 `baidu.com` 的话可以配置如下:

```bash
server {
  listen 80;
  server_name api.ytxcloud.com;

  location ~ /search/ {
    proxy_pass https://www.baidu.com;
  }

  location ~ /video/ {
    proxy_pass https://www.bilibili.com;
  }
}
```

反向代理还有一些其他的配置项，如下:

- `proxy_set_header`: 在将客户端请求发送给后端服务器之前，更改来自客户端的请求头信息
- `proxy_connect_timeout`: 配置 Nginx 与后端代理服务器尝试建立连接的超时时间
- `proxy_read_timeout`: 配置 Nginx 向后端服务器组发出read请求后，等待相应的超时时间
- `proxy_send_timeout`: 配置 Nginx 向后端服务器组发出write请求后，等待相应的超时时间
- `proxy_redirect`: 用于修改后端服务器返回的响应头中的 Location 和 Refresh

## 负载均衡

负载均衡的主要思路就是把负载合理分配到各个服务器上，实现压力分流，基础配置如下:

```bash
http {
  upstream myserver {
    server 127.0.0.1:8080;
    server 127.0.0.1:8081;
    server 127.0.0.1:8082 weight=10;
  }
}
```

Nginx 提供了几种不同的分配方式，默认为**轮询**, 分配方式如下:

- 轮询: 默认方式，每个请求按时间顺序逐一分配到不同的后端服务器，如果后端服务挂了，能自动剔除
- weight: 权重分配，指定轮询几率，权重越高，在被访问的概率越大，用于后端服务器性能不均的情况
- ip_hash: 每个请求按访问 IP 的 hash 结果分配，这样每个访客固定访问一个后端服务器，可以解决动态网页 session 共享问题。负载均衡每次请求都会重新定位到服务器集群中的某一个，那么已经登录某一个服务器的用户再重新定位到另一个服务器，其登录信息将会丢失，这样显然是不妥的
- fair: 按后端服务器的响应时间分配，响应时间短的优先分配，需要安装第三方插件 `nginx-upstream-fair`

## 跨域CORS配置



## 配置HTTPS

首先需要申请证书，完了之后将 `xxx.crt` 和 `xxx.key` 文件拷贝到服务器目录，在配置如下:

```bash
server {
  listen 443 ssl http2 default_server;
  server_name ytxcloud.com;

  ssl_certificate /etc/nginx/https/1_ytxcloud.com_bundle.crt;
  ssl_certificate_key /etc/nginx/https/2_ytxcloud.com.key;
  ssl_session_timeout 10m;

  ssl_protocols TLSv1 TLSv1.1 TLSv1.2;     # 请按照以下协议配置
  ssl_ciphers ECDHE-RSA-AES128-GCM-SHA256:HIGH:!aNULL:!MD5:!RC4:!DHE;
  ssl_prefer_server_ciphers on;

  add_header X-Frame-Options DENY;           # 减少点击劫持
  add_header X-Content-Type-Options nosniff; # 禁止服务器自动解析资源类型
  add_header X-Xss-Protection 1;             # 防XSS攻击

  location / {
    root /usr/share/nginx/html;
    index index.html index.htm;
  }
}
```

配置之后 `nginx -t -q` 检查一下，没问题就 `nginx -s reload` 重启一下，完了就可以访问 `https://ytxcloud.com` 网站了。

## 适配PC或移动设备

根据用户设备不同返回不同样式的站点，采用分开制作的方式，根据用户请求的 `user-agent` 来判断是返回 `PC` 还是 `H5` 站点。

在 `/usr/share/nginx/html` 目录下新建两件文件夹 `PC` 和 `Mobile`，然后到 `/etc/nginx/conf.d` 目录新建 `adapt.conf`，配置如下:

```bash
server {
  listen 80;
  server_name adapt.ytxcloud.com;

  location / {
    root /usr/share/nginx/html/PC;

    if ($http_user_agent ~* '(Android|webOS|iPhone|iPod|BlackBerry)') {
      root /usr/share/nginx/html/Mobile;
    }

    index index.html index.htm;
  }
}
```

可以看出主要是多了一个 `$http_user_agent` 全局变量来判断用户请求的 `user_agent`，从而指定不同的 root，返回对应的站点。

## 开启gzip压缩

gzip是一种常见的网页压缩技术，传输的网页经过 gzip 压缩之后通常可以变成一半大小，更小的网页体积也就意味着带宽的节约和传输速度的提升。


