---
title: '实现koa_mini'
date: 2019-08-26
permalink: 'node/koa_mini'
tag:
  - node
categories:
  - node
---

## 封装node http Server: 从hello world开始

首先不考虑框架，如果使用原生 http 模块来实现一个返回 hello world 的后端 app，代码如下:

```js
const http = require('http');
const server = http.createServer((req, res) => {
  res.writeHead(200);
  res.end('hello world');
});

server.listen(3000, () => {
  console.log('server listenning on port 3000');
})
```

实现 koa 的第一步，要对该原生过程进行封装，因此首先创建一个 `application.js` 来实现一个 `Application` 对象:

```js
const http = require('http');

class Application {
  /**
    * 构造函数
    */
  constructor() {
    this.callbackFunc;
  }
  
  /**
    * 开启http server并传入callback
    */
  listen(...args) {
    let server = http.createServer(this.callback());
    server.listen(...args);
  }

  /**
    * 挂载回调函数
    * @param {Function} fn 回调处理函数
    */
  use(fn) {
    this.callbackFunc = fn;
  }

  /**
    * 获取http server所需的callback函数
    * @return {Function} fn
    */
  callback() {
    return (req, res) => {
      this.callbackFn(req, res);
    }
  }
}

module.exports = Application;
```

然后创建 `example.js`:

```js
let SimpleKoa = require('./application');
let app = new SimpleKoa();

app.use((req, res) => {
  res.writeHead(200);
  res.end('hello world');
})

app.listen(3000, () => {
  console.log('server listenning on port 3000');
})
```

可以看到，我们已经初步完成了对于 http server 的封装，主要实现了 app.use 注册回调函数，app.listen 语法糖开启 server 并传入回调函数了，典型的 koa 风格。

但是美中不足的是，我们传入的回调函数，参数依然使用的是 req 和 res，也就是 node 原生的 request 和 response 对象，这些原生对象和 api 提供的方法不够便捷，不符合一个框架需要提供的易用性。

## 构造 request、response、context 对象

要明确对于 koa 的 request/response 对象，只是提供了对 node 原生 req/res 对象的一些方法的封装，因此使用 js 的 getter 和 setter 属性，基于 node 的对象 req/res 对象封装 koa 的 resquest/response 对象。

首先创建 `request.js`, 需要实现 **query** 读取方法，能够读取到 url 中的参数，返回一个对象。

```js
const url = require('url');

module.exports = {
  get query() {
    return url.parse(this.req.url, true).query;
  }
}
```

然后创建 `response.js`，实现 **status** 读写方法，分别读取和设置 http response 的状态码，以及 `body` 方法，用于构造返回信息。

```js
module.exports = {
  get body() {
    return this._body;
  },

  /**
   * 设置返回给客户端的body内容
   *
   * @param {mixed} data body内容
   */
  set body(data) {
    this._body = data;
  },

  get status() {
    return this.res.statusCode;
  },

  /**
   * 设置返回给客户端的stausCode
   *
   * @param {number} statusCode 状态码
   */
  set status(statusCode) {
    if (typeof statusCode !== 'number') {
      throw new Error('statusCode must be a number!');
    }
    this.res.statusCode = statusCode;
  }
};
```

最后创建 `context.js`, 用于挂载 request/response 对象，并对一些常用方法进行代理:

```js
module.exports = {
  get query() {
    return this.request.query;
  },

  get body() {
    return this.response.body;
  },

  set body(data) {
    this.response.body = data;
  },

  get status() {
    return this.response.status;
  },

  set status(statusCode) {
    this.response.status = statusCode;
  }
};
```

## 参考

[从头实现一个koa框架](https://zhuanlan.zhihu.com/p/35040744)