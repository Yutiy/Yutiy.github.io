---
title: 'pm2简介'
date: 2020-03-25
permalink: 'pm2'
tag:
  - pm2
categories:
  - pm2
---

# 常用命令

> [常用参数说明](http://pm2.keymetrics.io/docs/usage/quick-start/#options)

- `--watch`: 监听应用目录的变化，一旦发生变化则自动重启。
- `-i | --instances`: 启用多少个示例，可用于负载均衡。如果 `-i 0` 或者 `-i max`, 则根据当前机器核数确定实例数量。
- `--ignore-watch`: 排除监听的目录/文件，可以是特定的文件名，也可以是正则。
- `-n | --name`: 应用的名称，查看应用信息的时候可以用到。
- `-o | --output <path>`: 标准输出日志文件的路径。
- `-e | --error <path>`: 错误输出日志文件的路径。
- `--interpreter <interpreter>`: 应用解释器。

## 启动

`pm2 start app.js --watch -i 2`

## 查看进程状态

`pm2 list` 会返回各个应用的 名称 和 `id` 等信息。

## 重启

- 重启指定应用: `pm2 restart app_name|app_id`
- 重启所有应用: `pm2 restart all`

## 停止

- 停止指定应用: `pm2 stop app_name|app_id`
- 停止所有应用: `pm2 stop all`

## 删除

- 删除指定应用: `pm2 delete app_name|app_id`
- 删除所有应用: `pm2 delete all`

## 查看某个进程的信息

`pm2 show app_name|app_id`

## 监控每个node进程的 cpu 和 内存 使用情况

`pm2 monitor`

## 显示所有进程的日志信息

- 查看日志: `pm2 logs`
- 日志分割: `pm2 install pm2-logrotate`

# pm2-web实现监控可视化

`npm install -g pm2-web`

默认 `pm2-web` 会启动一个一个端口8080，但也可以使用配置的方式启用。

```json
// pm2-web-config.json
{
  "www": {
    "host": "localhost",
    "address": "0.0.0.0",
    "port": 6688
  }
}
```

# 配置文件

pm2 启动的方式可以进行很多的扩展，比如设置环境，设置错误信息打印，设置输入信息打印等等高级功能。那么一条命令就不能完成这些任务，所有 pm2 提供了配置文件的方式来启动～

```js
module.exports = {
  apps: [{
    name: 'blog-end',
    cwd: './',
    script: './src/index.js',

    // Options reference: https://pm2.keymetrics.io/docs/usage/quick-start/
    instances: 2,
    exec_mode: "cluster",
    autorestart: true,
    watch: ['src', 'build'],
    ignore_watch: [
      'node_modules',
      'logs',
      'public',
    ],
    kill_timeout: 3000,
    max_memory_restart: '1G',
    merge_logs: true,
    error_file: "./logs/pm2_error.log",
    out_file: "./logs/pm2_out.log",
    log_date_format: "YYYY-MM-DD HH:mm Z",
    env: {
      PORT: 6060,
      NODE_ENV: 'development'
    },
    env_production: {
      PORT: 6060,
      NODE_ENV: 'production'
    }
  }],

  deploy: {
    production: {
      user: 'yutiy',
      host: '118.25.178.76',
      ref: 'origin/master',
      repo: 'git@github.com:Yutiy/blog-end.git',
      // 项目的存放地址，会生成current, source, share目录
      path: '/work/blog/blog-end',
      'ssh_options': "StrictHostKeyChecking=no",
      "pre-setup": "echo 'This is a pre-setup command'",
      "post-setup": "ls -la",
      "pre-deploy-local": "echo 'This is a pre-deploy-local command'",
      'post-deploy': 'npm install && pm2 startOrRestart ecosystem.config.js --env production',
      env: {
        NODE_ENV: 'production'
      }
    },
  }
};
```

## 部署方法

> 部署 ssh 配置

在本地执行 `ssh-copy-id -i .ssh/id_rsa.pub yutiy@118.25.178.76` 复制本地的id_rsa.pub公钥到服务器。

> 发布前初始化配置

执行 `pm2 deploy ecosystem.config.js production setup`，配置以后，以后代码发布就无需再执行此步

> 部署代码

执行 `pm2 deploy ecosystem.config.js production`
